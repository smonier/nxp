<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NXP Semi Conductors</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
          integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">

    <script src="/script.js"></script>


</head>
<body>
<div class="center-block">
    <h1>Jahia / NXP</h1>
    <div id="connect" style="display: none;">
        <button class="meta-toggle" onclick='window.location.href = "http://localhost:8080/start"'>Let's connect
        </button>
    </div>
    <div id="main" style="display: none;">
        <h2><i class="fas fa-user-tie"></i> Hello <span id="username">{username}</span></h2>
    </div>
</div>
<div id="documentsList"></div>

<script>
    const getDocuments = async username => {
        const response = await fetch('http://localhost:8080/modules/graphql', {
            headers: {
                'X-Username': username,
                'Content-Type': 'application/json'
            },
            method: 'POST',
            body: JSON.stringify({
                query: `{
                              currentUser {
                                displayName
                                email
                              }
                              jcr(workspace: LIVE) {
                                nodeByPath(path: "/sites/systemsite/files") {
                                  path
                                  descendants(typesFilter: { types: ["jnt:file"] }) {
                                    pageInfo {
                                      totalCount
                                    }
                                    nodes {
                                      path
                                      name
                                      uuid
                                      type: property(name: "jcr:primaryType") {
                                        value
                                      }
                                      lastModif: property(name: "jcr:lastModified") {
                                        value
                                      }
                                      children {
                                        nodes {
                                          mimeType: property(name: "jcr:mimeType") {
                                            value
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }`
            })
        });
        if (response.ok) {
            const {data} = await response.json();
            document.getElementById('username').innerText = data.currentUser?.displayName + '  (' + data.currentUser?.email + ')';
            data.jcr?.nodeByPath?.descendants?.nodes?.forEach(node => {
                const {path, name, uuid, type, lastModif, children} = node;
                const mimeTypeValue = children.nodes.find(n => n.mimeType)?.mimeType?.value || 'unknown';
                const iconClass = getFontAwesomeIconFromMIME(mimeTypeValue);
                const formattedLastModif = new Date(lastModif.value).toLocaleString();

                // Using uuid to uniquely identify button and metadata div
                const buttonId = `meta-toggle-${uuid}`;
                const metadataDivId = `file-metadata-${uuid}`;

                const htmlString = `<div class="file-card"><i class="${iconClass} fa-2x" aria-hidden="true"></i><span class="file-name"><a href="http://localhost:8080/files/live${path}" title="${name}">${name}</a></span><button id="${buttonId}" class="meta-toggle" onclick="toggleMetadata('${buttonId}', '${metadataDivId}')">Show Metadata</button><div id="${metadataDivId}" class="file-metadata" style="display: none;"><p>Path: ${path}</p><p>UUID: ${uuid}</p><p>Type: ${type.value}</p><p>MIME Type: ${mimeTypeValue}</p><p>Last Modified: ${formattedLastModif}</p></div></div>`;

                document.getElementById('documentsList').innerHTML += htmlString;
            });

        }
    }


    /*        const getInfo = async (e, path) => {
        e.preventDefault();

        const response = await fetch('http://localhost:8080/modules/graphql', {
            headers: {
                'X-Username': username,
                'Content-Type': 'application/json'
            },
            method: 'POST',
            body: JSON.stringify({
                query: `query getInfo($path: String!) {
                  jcr(workspace: LIVE) {
                    nodeByPath(path: $path) {
                      path
                      name
                      type: property(name: "jcr:primaryType") { value }
                    }
                  }
                }`,
                variables: {path}
            })
        });
        message = `An error occured`;
        if (response.ok) {
            const {data} = await response.json();
            message = `${data.jcr?.nodeByPath?.name}: ${data.jcr?.nodeByPath?.type.value}\n${data.jcr?.nodeByPath?.path}`
        }
        alert(message);

        return false;
    };
*/
    const params = new URLSearchParams(window.location.search);
    const username = params.get('username');
    if (username) {
        document.getElementById('main').style.display = 'block';
        document.getElementById('username').innerText = username;
        document.getElementById('connect').style.display = 'none';
        getDocuments(username);
    } else {
        document.getElementById('main').style.display = 'none';
        document.getElementById('connect').style.display = 'block';
    }

</script>


</body>
</html>
